name: Notify LINE from kintone

on:
  schedule:
    - cron: '0 16 * * *'   # æ¯æ—¥25æ™‚ï¼ç¿Œæ—¥1æ™‚ï¼šæœªå¯¾å¿œã‚¢ãƒ©ãƒ¼ãƒˆ
    - cron: '0 23 * * *'   # æ¯æœ8æ™‚ï¼šæœ¬æ—¥ã‚¢ãƒé€šçŸ¥ï¼ˆUTCã§23æ™‚ï¼‰
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install axios dayjs

      - name: Run notification script
        env:
          KINTONE_TOKEN: ${{ secrets.KINTONE_TOKEN }}
          KINTONE_DOMAIN: ${{ secrets.KINTONE_DOMAIN }}
          LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
          GROUP_ID: ${{ secrets.GROUP_ID }}
        run: |
          echo "Running notification..."
          node <<'EOF'
          const axios = require("axios");
          const dayjs = require("dayjs");

          (async () => {
            const today = dayjs().format("YYYY-MM-DD");
            const hour = dayjs().hour();

            const res = await axios.get(
              `https://${process.env.KINTONE_DOMAIN}/k/v1/records.json`,
              {
                headers: { "X-Cybozu-API-Token": process.env.KINTONE_TOKEN },
                params: {
                  app: 10,
                  query: `day >= \"${today}\" and day <= \"${today}\"`
                }
              }
            );

            const records = res.data.records;
            if (records.length === 0) {
              console.log("âœ… é€šçŸ¥å¯¾è±¡ãªã—");
              return;
            }

            let message = "";

            if (hour === 16) {
              // æœªå¯¾å¿œã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆ25æ™‚ï¼1æ™‚ï¼‰
              const alertRecords = records.filter(r => r["eigyo_status"].value === "ä¿ç•™" && r["day"].value < today);
              if (alertRecords.length === 0) {
                console.log("âœ… æœªå¯¾å¿œã‚¢ãƒ©ãƒ¼ãƒˆå¯¾è±¡ãªã—");
                return;
              }
              message = "\uD83D\uDEA8ã€å•†è«‡æœªå¯¾å¿œã‚¢ãƒ©ãƒ¼ãƒˆã€‘\n\nä»¥ä¸‹ã®æ¡ˆä»¶ãŒã€Œä¿ç•™ã€ã®ã¾ã¾ã§ã™âš ï¸\n\n";
              for (const r of alertRecords) {
                message += `ğŸ‘¤ é¡§å®¢åï¼š${r["line_name"].value}\n`;
                message += `ğŸ“… å•†è«‡äºˆå®šæ—¥ï¼š${r["day"].value.split("T")[0]}\n`;
                message += `ğŸ™â€â™‚ï¸ å–¶æ¥­æ‹…å½“ï¼š${r["ooo"].value}\n\n`;
              }
              message += "ã”ç¢ºèªãŠé¡˜ã„ã—ã¾ã™ï¼";

            } else if (hour === 23) {
              // å½“æ—¥ã‚¢ãƒé€šçŸ¥ï¼ˆæœ8æ™‚ï¼‰
              message = "ğŸ“…ã€æœ¬æ—¥ã‚¢ãƒã®ã”æ¡ˆå†…ã€‘\n\n";
              for (const r of records) {
                message += `ğŸ‘¤ é¡§å®¢åï¼š${r["line_name"].value}\n`;
                message += `ğŸ“… å•†è«‡äºˆå®šæ—¥ï¼š${r["day"].value.split("T")[0]}\n`;
                message += `ğŸ™â€â™‚ï¸ å–¶æ¥­æ‹…å½“ï¼š${r["ooo"].value}\n\n`;
              }
              message += "æœ¬æ—¥ã‚¢ãƒãŒã‚ã‚Šã¾ã™ã€‚ã”å¯¾å¿œãŠé¡˜ã„ã—ã¾ã™ï¼";
            }

            await axios.post("https://api.line.me/v2/bot/message/push",
              {
                to: process.env.GROUP_ID,
                messages: [{ type: "text", text: message }]
              },
              {
                headers: {
                  Authorization: `Bearer ${process.env.LINE_TOKEN}`,
                  "Content-Type": "application/json"
                }
              }
            );

            console.log("ğŸ“¤ LINEé€šçŸ¥é€ä¿¡å®Œäº†ï¼");
          })().catch(e => {
            console.error("âŒ ã‚¨ãƒ©ãƒ¼", e.response?.data || e.message);
            process.exit(1);
          });
          EOF



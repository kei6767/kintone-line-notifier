name: Notify LINE from kintone

on:
  schedule:
    - cron: '0 16 * * *'  # JSTã§25æ™‚ = ç¿Œæ—¥1æ™‚
    - cron: '0 23 * * *'  # JSTã§8æ™‚ï¼ˆUTC+9 = 23æ™‚å‰æ—¥ï¼‰
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install axios dayjs

      - name: Run notification script
        env:
          KINTONE_TOKEN: ${{ secrets.KINTONE_TOKEN }}
          KINTONE_DOMAIN: ${{ secrets.KINTONE_DOMAIN }}
          LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
          GROUP_ID: ${{ secrets.GROUP_ID }}
        run: |
          echo "Running notification..."
          node <<'EOF'
          const axios = require("axios");
          const dayjs = require("dayjs");
          const utc = require("dayjs/plugin/utc");
          const timezone = require("dayjs/plugin/timezone");
          dayjs.extend(utc);
          dayjs.extend(timezone);

          const today = dayjs().tz("Asia/Tokyo").format("YYYY-MM-DD");

          const fetchRecords = async (query) => {
            const res = await axios.get(
              `https://${process.env.KINTONE_DOMAIN}/k/v1/records.json`,
              {
                headers: { "X-Cybozu-API-Token": process.env.KINTONE_TOKEN },
                params: {
                  app: 10,
                  query,
                },
              }
            );
            return res.data.records;
          };

          const sendLineMessage = async (text) => {
            await axios.post("https://api.line.me/v2/bot/message/push",
              {
                to: process.env.GROUP_ID,
                messages: [{ type: "text", text }],
              },
              {
                headers: {
                  Authorization: `Bearer ${process.env.LINE_TOKEN}`,
                  "Content-Type": "application/json",
                },
              }
            );
          };

          const main = async () => {
            let sent = false;

            // â‘  ä¿ç•™ + éå»æ—¥ä»˜
            const overdueRecords = await fetchRecords(
              `eigyo_status in ("ä¿ç•™") and day < "${today}"`
            );
            if (overdueRecords.length > 0) {
              let message = "ğŸš¨ã€å•†è«‡æœªå¯¾å¿œã‚¢ãƒ©ãƒ¼ãƒˆã€‘\n\nä»¥ä¸‹ã®æ¡ˆä»¶ãŒã€Œä¿ç•™ã€ã®ã¾ã¾ã§ã™âš ï¸\n\n";
              for (const r of overdueRecords) {
                message += `ğŸ‘¤ é¡§å®¢åï¼š${r["line_name"].value}\n`;
                message += `ğŸ“… å•†è«‡äºˆå®šæ—¥ï¼š${r["day"].value.split("T")[0]}\n`;
                message += `ğŸ™â€â™‚ï¸ å–¶æ¥­æ‹…å½“ï¼š${r["ooo"].value}\n\n`;
              }
              message += "ã”ç¢ºèªãŠé¡˜ã„ã—ã¾ã™ï¼";
              await sendLineMessage(message);
              sent = true;
            }

            // â‘¡ æœ¬æ—¥ã‚¢ãƒã‚ã‚Š
            const todayRecords = await fetchRecords(
              `day like "${today}"`
            );
            if (todayRecords.length > 0) {
              let message = "âœ…ã€æœ¬æ—¥ã®å•†è«‡äºˆå®šã€‘\n\nä»¥ä¸‹ã®æ¡ˆä»¶ãŒã‚ã‚Šã¾ã™ğŸ“…\n\n";
              for (const r of todayRecords) {
                message += `ğŸ‘¤ é¡§å®¢åï¼š${r["line_name"].value}\n`;
                message += `ğŸ“… å•†è«‡äºˆå®šæ—¥ï¼š${r["day"].value.split("T")[0]}\n`;
                message += `ğŸ™â€â™‚ï¸ å–¶æ¥­æ‹…å½“ï¼š${r["ooo"].value}\n\n`;
              }
              message += "æœ¬æ—¥ã‚¢ãƒå¯¾å¿œã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼";
              await sendLineMessage(message);
              sent = true;
            }

            if (!sent) {
              console.log("âœ… é€šçŸ¥å¯¾è±¡ãªã—");
            } else {
              console.log("ğŸ“¤ LINEé€šçŸ¥é€ä¿¡å®Œäº†");
            }
          };

          main().catch((e) => {
            console.error("âŒ ã‚¨ãƒ©ãƒ¼", e.response?.data || e.message);
            process.exit(1);
          });
          EOF






name: Notify LINE from kintone

on:
  schedule:
    - cron: '0 16 * * *' # æ—¥æœ¬æ™‚é–“25æ™‚ï¼ˆUTC16æ™‚ï¼‰
    - cron: '0 23 * * *' # æ—¥æœ¬æ™‚é–“8æ™‚ï¼ˆUTC23æ™‚ï¼‰
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: Install dependencies
      run: npm install axios dayjs

    - name: Run notification script
      env:
        KINTONE_TOKEN: ${{ secrets.KINTONE_TOKEN }}
        KINTONE_DOMAIN: ${{ secrets.KINTONE_DOMAIN }}
        LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
        GROUP_ID: ${{ secrets.GROUP_ID }}
      run: |
        echo "Running notification..."
        node <<'EOF'
        const axios = require("axios");
        const dayjs = require("dayjs");

        (async () => {
          const today = dayjs().format("YYYY-MM-DD");
          const tomorrow = dayjs(today).add(1, 'day').format("YYYY-MM-DD");

          const headers = {
            "X-Cybozu-API-Token": process.env.KINTONE_TOKEN
          };

          const appId = 10;
          const kintoneUrl = `https://${process.env.KINTONE_DOMAIN}/k/v1/records.json`;

          let messages = [];

          // â–¼ ä¿ç•™é€šçŸ¥ï¼ˆå•†è«‡æœªå¯¾å¿œï¼‰
          try {
            const resPending = await axios.get(kintoneUrl, {
              headers,
              params: {
                app: appId,
                query: `eigyo_status in ("ä¿ç•™") and day < "${today}"`
              }
            });

            const records = resPending.data.records;
            if (records.length > 0) {
              let msg = "ã€å•†è«‡æœªå¯¾å¿œã‚¢ãƒ©ãƒ¼ãƒˆã€‘\n\nä»¥ä¸‹ã®æ¡ˆä»¶ãŒã€Œä¿ç•™ã€ã®ã¾ã¾ã§ã™ã€‚\n\n";
              for (const r of records) {
                msg += `é¡§å®¢åï¼š${r["line_name"].value}\nå•†è«‡äºˆå®šæ—¥ï¼š${r["day"].value.split("T")[0]}\nå–¶æ¥­æ‹…å½“ï¼š${r["ooo"].value}\n\n`;
              }
              msg += "ã”ç¢ºèªãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚";
              messages.push(msg);
            }
          } catch (e) {
            console.error("âŒ ä¿ç•™é€šçŸ¥ã‚¨ãƒ©ãƒ¼", e.response?.data || e.message);
            process.exit(1);
          }

          // â–¼ æœ¬æ—¥ã‚¢ãƒé€šçŸ¥
          try {
            const resToday = await axios.get(kintoneUrl, {
              headers,
              params: {
                app: appId,
                query: `day >= "${today}" and day < "${tomorrow}"`
              }
            });

            const records = resToday.data.records;
            if (records.length > 0) {
              let msg = "ã€æœ¬æ—¥ã‚¢ãƒé€šçŸ¥ã€‘\n\næœ¬æ—¥ã‚¢ãƒãŒã‚ã‚‹æ–¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼\n\n";
              for (const r of records) {
                msg += `é¡§å®¢åï¼š${r["line_name"].value}\nå•†è«‡æ™‚é–“ï¼š${r["day"].value.replace("T", " ").slice(0, 16)}\nå–¶æ¥­æ‹…å½“ï¼š${r["ooo"].value}\n\n`;
              }
              msg += "æœ¬æ—¥ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ï¼";
              messages.push(msg);
            }
          } catch (e) {
            console.error("âŒ æœ¬æ—¥ã‚¢ãƒé€šçŸ¥ã‚¨ãƒ©ãƒ¼", e.response?.data || e.message);
            process.exit(1);
          }

          // â–¼ LINEé€ä¿¡å‡¦ç†
          if (messages.length > 0) {
            for (const text of messages) {
              await axios.post("https://api.line.me/v2/bot/message/push",
                {
                  to: process.env.GROUP_ID,
                  messages: [{ type: "text", text }]
                },
                {
                  headers: {
                    Authorization: `Bearer ${process.env.LINE_TOKEN}`,
                    "Content-Type": "application/json"
                  }
                }
              );
            }
            console.log("ğŸ“¤ LINEé€šçŸ¥é€ä¿¡å®Œäº†");
          } else {
            console.log("âœ… é€šçŸ¥å¯¾è±¡ãªã—");
          }
        })().catch(e => {
          console.error("âŒ ã‚¨ãƒ©ãƒ¼", e.response?.data || e.message);
          process.exit(1);
        });
        EOF

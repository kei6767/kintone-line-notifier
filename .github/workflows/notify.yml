    - name: Install dependencies
      run: npm install axios dayjs dayjs-plugin-utc dayjs-plugin-timezone

    - name: Run notification script
      env:
        KINTONE_TOKEN: ${{ secrets.KINTONE_TOKEN }}
        KINTONE_DOMAIN: ${{ secrets.KINTONE_DOMAIN }}
        LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
        GROUP_ID: ${{ secrets.GROUP_ID }}
      run: |
        echo "Running notification..."
        node <<'EOF'
        const axios = require("axios");
        const dayjs = require("dayjs");
        const utc = require("dayjs/plugin/utc");
        const timezone = require("dayjs/plugin/timezone");
        dayjs.extend(utc);
        dayjs.extend(timezone);

        (async () => {
          const today = dayjs().tz("Asia/Tokyo").format("YYYY-MM-DD");

          const headers = { "X-Cybozu-API-Token": process.env.KINTONE_TOKEN };
          const appId = 10;

          // ğŸ”” å•†è«‡æœªå¯¾å¿œï¼ˆä¿ç•™ï¼‰ã‚¢ãƒ©ãƒ¼ãƒˆ
          const holdRes = await axios.get(`https://${process.env.KINTONE_DOMAIN}/k/v1/records.json`, {
            headers,
            params: {
              app: appId,
              query: `eigyo_status in ("ä¿ç•™") and day < "${today}"`
            }
          });

          const holdRecords = holdRes.data.records;

          if (holdRecords.length > 0) {
            let message = "ğŸš¨ã€å•†è«‡æœªå¯¾å¿œã‚¢ãƒ©ãƒ¼ãƒˆã€‘\n\nä»¥ä¸‹ã®æ¡ˆä»¶ãŒã€Œä¿ç•™ã€ã®ã¾ã¾ã§ã™âš ï¸\n\n";
            for (const r of holdRecords) {
              message += `ğŸ‘¤ é¡§å®¢åï¼š${r["line_name"].value}\n`;
              message += `ğŸ“… å•†è«‡äºˆå®šæ—¥ï¼š${r["day"].value.split("T")[0]}\n`;
              message += `ğŸ™â€â™‚ï¸ å–¶æ¥­æ‹…å½“ï¼š${r["ooo"].value}\n\n`;
            }
            message += "ã”ç¢ºèªãŠé¡˜ã„ã—ã¾ã™ï¼";

            await axios.post("https://api.line.me/v2/bot/message/push", {
              to: process.env.GROUP_ID,
              messages: [{ type: "text", text: message }]
            }, {
              headers: {
                Authorization: `Bearer ${process.env.LINE_TOKEN}`,
                "Content-Type": "application/json"
              }
            });

            console.log("ğŸ“¤ ä¿ç•™ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥å®Œäº†ï¼");
          }

          // ğŸ”” å½“æ—¥ã‚¢ãƒé€šçŸ¥
          const todayRes = await axios.get(`https://${process.env.KINTONE_DOMAIN}/k/v1/records.json`, {
            headers,
            params: {
              app: appId,
              query: `day = "${today}"`
            }
          });

          const todayRecords = todayRes.data.records;

          if (todayRecords.length > 0) {
            let message = "ğŸ“…ã€æœ¬æ—¥ã‚¢ãƒé€šçŸ¥ã€‘\n\nä»¥ä¸‹ã®ãŠå®¢æ§˜ã«æœ¬æ—¥ã‚¢ãƒãŒã‚ã‚Šã¾ã™ï¼\n\n";
            for (const r of todayRecords) {
              message += `ğŸ‘¤ é¡§å®¢åï¼š${r["line_name"].value}\n`;
              message += `â° æ™‚é–“ï¼š${r["day"].value.split("T")[0]}\n`;
              message += `ğŸ™â€â™‚ï¸ æ‹…å½“ï¼š${r["ooo"].value}\n\n`;
            }
            message += "å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼";

            await axios.post("https://api.line.me/v2/bot/message/push", {
              to: process.env.GROUP_ID,
              messages: [{ type: "text", text: message }]
            }, {
              headers: {
                Authorization: `Bearer ${process.env.LINE_TOKEN}`,
                "Content-Type": "application/json"
              }
            });

            console.log("ğŸ“¤ æœ¬æ—¥ã‚¢ãƒé€šçŸ¥å®Œäº†ï¼");
          }

          if (holdRecords.length === 0 && todayRecords.length === 0) {
            console.log("âœ… é€šçŸ¥å¯¾è±¡ãªã—");
          }

        })().catch(e => {
          console.error("âŒ ã‚¨ãƒ©ãƒ¼", e.response?.data || e.message);
          process.exit(1);
        });
        EOF



